<!doctype html>
<html lang="en">
<head>
  <title>Blend Trimix</title>
  <meta name="description"
    content="Calculate a trimix blend based on Helium, Oxygen and Air.">
  <meta name="viewport" content="width=device-width">
  <meta name="theme-color" content="#19d1f1">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">  
  <link rel="manifest" href="/trimix/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/nitrox/icon-192x192.png">
  <style>
    body {
      margin: 1em;
      font-family: Arial, Helvetica, sans-serif;
    }

    fieldset {
      margin: 0.3em;
    }

    .warning {
      border: 1px solid red;
      padding: 0.1em 1em;
    }
    
    th, td { padding: 0.5em; }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://maxcdn.bootstrapcdn.com">
  <link rel="preconnect" href="https://maxcdn.bootstrapcdn.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
  <link rel="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="../nitrox/nitrox.css">

</head>

<body>
  <h1>Blend Trimix</h1>
  <div class="warning">
    <h2>Warning!</h2>
    <p>
      This tool is for convenience. It is provided as is and may be faulty.
      <strong>It does not replace measuring of the gas mix!</strong>
    </p>
    <p>
      Use this at your own risk!
    </p>
  </div>

  <h2>Calculator</h2>
  The form below lets you calculate the expected mixture generated by filling a tank with known mixture with oxygen, helium and air to a given end pressure.
  It only provides an approximation and you <strong>always have to measure the actual tank content</strong> after
  filling with an analyzer!

  <details open>
    <summary>Current tank content</summary>
    <div class="input-group">
      <label>
        Current tank pressure (bar)
        <input id="startPressure" type="number" min="0" max="300" value="100" maxlength="3">
      </label>
    </div>
    <div class="input-group">
      <label>
        Current oxygen content (%)
        <input id="startO2" value="21" type="number" min="0" max="100" step="1" maxlength="3">
      </label>
    </div>
    <div class="input-group">
        <label>
          Current oxygen content (%)
          <input id="startHe" value="35" type="number" min="0" max="100" step="1" maxlength="3">
        </label>
      </div>
    </details>
  <details open>
    <summary>Filling information</summary>
    <div class="input-group">
      <label>
        Final pressure (bar)
        <input id="endPressure" type="number" value="210" min="0" max="300" step="5" maxlength="3">
      </label>
    </div>
    <div class="input-group">
      <label>
        Desired oxygen content (%)
        <input id="endO2" type="number" value="21" min="0" max="100" step="1" maxlength="3">
      </label>
    </div>
    <div class="input-group">
      <label>
        Desired Helium content (%)
        <input id="endHe" type="number" value="35" min="0" max="100" step="1" maxlength="3">
      </label>
    </div>
  </details>

  <button id="mix" type="button">Calculate</button>
  <h2>Blending steps</h2>
  <table>
    <thead>
      <tr>
        <th>Gas</th>
        <th>Add</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>


  <script>
  const FN2_AIR = 0.79;
  const resultContainer = document.querySelector('tbody');

  if(!location.href.match('/trimix/$')) location.href = '/trimix/';
  if(!location.href.match('^https')) location.href = 'https://divingfor.fun/trimix/';



    document.querySelector('button#mix').addEventListener('click', function () {
      // get all the numbers from the DOM
      const pressureStart = parseFloat(document.getElementById('startPressure').value);
      const fracO2Start = parseFloat(document.getElementById('startO2').value) / 100.0;
      const fracHeStart = parseFloat(document.getElementById('startHe').value) / 100.0;
      const pressureEnd = parseFloat(document.getElementById('endPressure').value);
      const fracO2End = parseFloat(document.getElementById('endO2').value) / 100.0;
      const fracHeEnd = parseFloat(document.getElementById('endHe').value) / 100.0;

      // how much pressure do we already have for our two filling gases?
      const pHeStart = fracHeStart * pressureStart;
      const pO2Start = fracO2Start * pressureStart;
    
      // how much nitrogen is missing?
      const n2FractionStart = 1.0 - (fracHeStart + fracO2Start); // % of N2 in start mix
      const n2FractionEnd = 1.0 - (fracO2End + fracHeEnd) //% of N2 in final mix
      const pN2Start = n2FractionStart * pressureStart;
      const pN2End = n2FractionEnd * pressureEnd;
      const pN2Missing = (pN2End - pN2Start);

      // how much pressure do we need at the end?
      const pHeEnd = fracHeEnd * pressureEnd;
      const pO2End = fracO2End * pressureEnd;

      // top up needed
      const topupPressure = pressureEnd - pressureStart;
      const topupHe = pHeEnd - pHeStart;
      const topupAir = pN2Missing / FN2_AIR;
      const topupO2 = topupPressure - (topupHe + topupAir);

      resultContainer.innerHTML = '';
      resultContainer.appendChild(createRow('Oxygen', topupO2, pressureStart + topupO2));
      resultContainer.appendChild(createRow('Helium', topupHe, pressureStart + topupO2 + topupHe));
      resultContainer.appendChild(createRow('Air',    topupAir, pressureStart + topupO2 + topupHe + topupAir));

    });

    function createRow(gas, topup, total) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${gas}</td><td>${topup.toFixed(1)} bar</td><td>${total.toFixed(1)} bar</td>`;
        return tr;
    }

    /*
    if('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/nitrox/sw.js');
      });
    }
    */
  </script>
</body>

</html>
